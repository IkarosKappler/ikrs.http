package ikrs.http;

/**
 * This class wraps HTTPHeaderLines together into a list like searchable structure.
 *
 * @author Henning Diesenberg
 * @date 2012-05-21
 * @version 1.0.0
 **/


import java.io.EOFException;
import java.io.InputStream;
import java.io.IOException;


import java.util.ArrayList;
import java.util.Map;
import java.util.HashMap;
import java.util.Iterator;
import java.util.Set;
import java.util.TreeSet;


//import ikrs.util.CaseInsensitiveComparator;


public class HTTPHeaders {
    //extends ArrayList<HTTPHeaderLine> {

    private String command;
    private String protocol;
    private String version;

    private Map<String,Set<HTTPHeaderLine>> map;
    private ArrayList<HTTPHeaderLine> list;


    private HTTPHeaders() {
	super();


	this.list = new ArrayList<HTTPHeaderLine>(4);
	this.map = new HashMap<String,Set<HTTPHeaderLine>>(); // CaseInsensitiveComparator.sharedInstance );
    }

    /**
     * This method registers the given HTTPHeader line into the search map.
     **/
    private void registerToMap( HTTPHeaderLine element ) {
	
	Set<HTTPHeaderLine> set = this.map.get( element.getKey() );
	if( set == null ) {
	    // Container not found -> create new
	    set = new TreeSet<HTTPHeaderLine>();
	    this.map.put( element.getKey(), set );
	}
	
	set.add( element );
    }

    /**
     * This method releases the given HTTPHeaderLine from the search map.
     **/
    private boolean releaseFromMap( HTTPHeaderLine element ) {
	
	Set<HTTPHeaderLine> set = this.map.get( element.getKey() );
	if( set == null ) {
	    // Container not found
	    return false;
	}

	boolean removed = set.remove( element );
	if( !removed ) {
	    // Not found in container
	    return false;
	}

	// Fully remove container?
	if( set.size() == 0 ) {

	    this.map.remove( element.getKey() );

 	} 

	return true;
    }

    public Set<HTTPHeaderLine> getHeaders( String name ) {
	// Get the set widht the elements
	Set<HTTPHeaderLine> set = this.map.get( name );
	
	// make a copy
	Set<HTTPHeaderLine> result = new TreeSet<HTTPHeaderLine>();
	Iterator<HTTPHeaderLine> iter = set.iterator();
	while( iter.hasNext() ) {
	    
	    // Hint: HTTPHeaderLines are immutable -> no need to clone
	    result.add( iter.next() );

	}
	
	return result;
    }

    //---BEGIN------------------------- Override List's access methods ------------------
    public boolean add( HTTPHeaderLine e ) {
	boolean b = this.list.add( e );
	if( b )
	    this.registerToMap( e );

	//if( this.list.size() == 1 ) {
	//    parseFirstLine(e);
	//}
	return b;
    }
        
    /*public void add ( int index, HTTPHeaderLine element ) 
	throws IndexOutOfBoundsException {

	this.list.add( index, element );
	this.registerToMap( element );
	}*/
    
    /*
    public void	clear() {
	this.list.clear();
	this.map.clear();
    }
    */
      
    /*
    public Object clone() {
	return null;
    }
    */
     
    public HTTPHeaderLine get( int index ) 
	throws IndexOutOfBoundsException {
	return this.list.get( index );
    }
   
    /*
    public HTTPHeaderLine remove(int index)  
	throws IndexOutOfBoundsException {

	HTTPHeaderLine h = this.list.remove(index);
	if( h != null )
	    this.releaseFromMap( h );

	return h;
    }
    */
              
    /*
    public HTTPHeaderLine set( int index, HTTPHeaderLine element )  
	throws IndexOutOfBoundsException {
	
	// Find current element
	HTTPHeaderLine old = this.list.get( index );
	this.registerToMap( element );
	
	return old;
    } 
    */
    //---END--------------------------- Override List's access methods ------------------

    public int size() {
	return this.list.size();
    }

    public String getCommand() {
	if( this.command == null )
	    this.splitFirstLine();

	return this.command;
    }

    public String getProtocol() {
	if( this.protocol == null )
	    this.splitFirstLine();

	return this.protocol;
    }

    public String getVersion() {
	if( this.version == null )
	    this.splitFirstLine();

	return this.version;
    }


    private boolean splitFirstLine() {

	if( this.list.size() == 0 )
	    return false;
	
	HTTPHeaderLine first = this.list.get(0);
	String key = first.getKey();
	if( key == null )
	    return false;


	// The first line should have this format (or like that):
	// GET / HTTP/1.1
	String[] split = key.split( "(\\s)++" );
	if( split.length != 3 )
	    return false;
	

	this.command = split[0];
	this.protocol = split[1];
	this.version = split[2];	

	return true;
    }

    public static HTTPHeaders read( InputStream in )
	throws EOFException,
	IOException {

	
	HTTPHeaders headers = new HTTPHeaders();


	HTTPHeaderLine header = null;
	// Read line by line; the first occurence of an empty line indicates the end-of-headers, which means
	// the HTTPHeaderLine.read(...) returns null.
	while( (header = HTTPHeaderLine.read(in)) != null ) {
	    System.out.println( "HTTPHeaders.read(...) HTTPHeaders.read(..) header line: " + header );
	    
	    headers.add( header );
	}

	
	return headers;
    }

}